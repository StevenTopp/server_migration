<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»‡æ¢¦è€… (DreamWeaver)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #09090b; color: #a1a1aa; font-family: -apple-system, system-ui, sans-serif; }
        .prose { max-width: none; color: #d4d4d8; line-height: 1.8; }
        .glass { background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .btn-primary { background: #e4e4e7; color: #18181b; transition: all 0.2s; }
        .btn-primary:hover { background: #d4d4d8; }
        .btn-primary:active { transform: scale(0.96); }
        .loader { border: 3px solid #3f3f46; border-top: 3px solid #e4e4e7; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Modal åŠ¨ç”» */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s; }
        /* å…‰æ ‡é—ªçƒ */
        .cursor-blink::after { content: '|'; animation: blink 1s step-end infinite; color: #a1a1aa; margin-left: 1px; font-weight: 200; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* æ‚¬æµ®æŒ‰é’®ç»„ */
        .float-actions {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        /* é¡¶éƒ¨é¢„è§ˆæ¡†æ ·å¼ */
        #topHeader {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 400px; /* é»˜è®¤å±•å¼€æ€çš„æœ€å¤§é«˜åº¦ */
            overflow: hidden;
        }

        /* å¸é™„æ€ (Collapsed) */
        .header-collapsed {
            max-height: 28px !important; /* å‹ç¼©ä¸ºç»†æ¡ */
            padding: 0 !important;
            opacity: 0.8;
            cursor: pointer;
            background: rgba(24, 24, 27, 0.95) !important;
            border-bottom: 1px solid rgba(255,255,255,0.05) !important;
        }
        .header-collapsed:hover {
            opacity: 1;
        }
        /* å¸é™„æ€ä¸‹éšè—å†…éƒ¨ä¸»è¦å†…å®¹ */
        .header-collapsed .header-content {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s;
        }
        /* å¸é™„æ€ä¸‹æ˜¾ç¤ºæŠŠæ‰‹ */
        .header-collapsed .header-handle {
            opacity: 1;
            pointer-events: auto;
        }
        /* æ­£å¸¸æ€ä¸‹éšè—æŠŠæ‰‹ */
        .header-handle {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        /* å¤åˆ¶æŒ‰é’®æ˜¾éš */
        .copy-btn { opacity: 0; transition: opacity 0.2s; }
        .group:hover .copy-btn { opacity: 1; }
        /* å¸é™„æ—¶å¼ºåˆ¶éšè—å¤åˆ¶æŒ‰é’® */
        .header-collapsed .copy-btn { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- é¡¶éƒ¨æ  -->
    <header class="h-14 flex items-center justify-between px-4 border-b border-white/10 bg-[#09090b]/80 backdrop-blur shrink-0 z-30">
        <div class="flex items-center gap-2">
            <h1 class="font-bold text-lg text-gray-200 tracking-wide">ç»‡æ¢¦è€…</h1>
        </div>
        <div class="flex gap-3">
            <button onclick="showNewNovel()" class="text-sm bg-gray-200 text-gray-900 hover:bg-gray-300 px-3 py-1.5 rounded-full flex items-center gap-1 font-medium shadow-lg shadow-white/5 transition-colors">
                <span>âœ¨ æ–°å»º</span>
            </button>
            <button onclick="showHelp()" class="text-gray-500 hover:text-gray-300 text-xl transition-colors w-8 h-8 flex items-center justify-center" title="ä½¿ç”¨è¯´æ˜">?</button>
            <button onclick="toggleConfig()" class="text-gray-500 hover:text-gray-300 text-xl transition-colors w-8 h-8 flex items-center justify-center">âš™ï¸</button>
        </div>
    </header>

    <!-- æ–°å»ºå°è¯´ Modal -->
    <div id="newNovelModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[#1f2937] w-full max-w-lg rounded-xl p-6 shadow-2xl border border-purple-500/30">
            <h2 class="text-xl font-bold mb-1 text-white flex items-center gap-2">
                <span class="text-2xl">ğŸ“</span> åˆ›å»ºæ–°å°è¯´
            </h2>
            <p class="text-xs text-gray-500 mb-4 pl-9">æç¤ºï¼šæ‰€æœ‰é€‰é¡¹å‡å¯ä¸å¡«ï¼Œæˆ–åœ¨â€œæ¢—æ¦‚â€ä¸­è¾“å…¥æ¨¡ç³Šæƒ³æ³•ï¼Œè®© AI è‡ªç”±å‘æŒ¥ã€‚</p>
            <div class="space-y-3 text-sm">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-gray-400">ä¸»è§’å§“å</label>
                        <input id="new_name" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1" placeholder="ä¾‹ï¼šæ—å‡¡">
                    </div>
                    <div>
                        <label class="text-gray-400">å¹´é¾„</label>
                        <input id="new_age" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1" placeholder="18å²">
                    </div>
                </div>
                <div>
                    <label class="text-gray-400">å°è¯´é£æ ¼</label>
                    <input id="new_style" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1" placeholder="ç„å¹»ã€èµ›åšæœ‹å…‹ã€è¨€æƒ…...">
                </div>
                <div>
                    <label class="text-gray-400">é¢„æœŸæ€»å­—æ•°</label>
                    <input id="new_count" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1" placeholder="300ä¸‡å­—">
                </div>
                <div>
                    <label class="text-gray-400">æ•…äº‹å¤§æ¦‚èµ°å‘/æ¢—æ¦‚</label>
                    <textarea id="new_plot" rows="4" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1" placeholder="ç®€è¿°ä¸–ç•Œè§‚ã€æ ¸å¿ƒå†²çªã€ç»“å±€èµ°å‘..."></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="hideNewNovel()" class="px-4 py-2 rounded text-gray-400 hover:bg-gray-800">å–æ¶ˆ</button>
                <button onclick="createOutline()" class="px-5 py-2 rounded bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold hover:opacity-90">å¼€å§‹ç”Ÿæˆ</button>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨è¯´æ˜ Modal -->
    <div id="helpModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[#1f2937] w-full max-w-2xl rounded-xl p-0 shadow-2xl border border-gray-700 max-h-[85vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-[#2a303c] rounded-t-xl">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">ä½¿ç”¨æŒ‡å—</h2>
                <button onclick="hideHelp()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto prose prose-invert prose-sm max-w-none text-gray-300">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                        <h3 class="text-blue-400 mt-0">å¿«é€Ÿå¼€å§‹</h3>
                        <ol class="text-sm space-y-1 pl-4 mb-0">
                            <li>ç‚¹å‡»é¡¶éƒ¨ <strong>æ–°å»º</strong> æŒ‰é’®ã€‚</li>
                            <li>è¾“å…¥ä¸»è§’ã€é£æ ¼ã€å¤§æ¦‚å‰§æƒ…èµ°å‘ï¼ˆå¯ç•™ç©ºï¼‰ã€‚</li>
                            <li>AI ç”Ÿæˆå¤§çº²ï¼Œç‚¹å‡» <strong>é‡‡çº³å¹¶å†™å…¥</strong>ã€‚</li>
                            <li>ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºæ–°ä¹¦å¹¶é‡å‘½åã€‚</li>
                            <li>åº•éƒ¨ç›´æ¥è¾“å…¥æŒ‡ä»¤ï¼ˆæˆ–ç•™ç©ºï¼‰å¼€å§‹ç»­å†™ã€‚</li>
                        </ol>
                    </div>
                    <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                        <h3 class="text-green-400 mt-0">æ ¸å¿ƒæœºåˆ¶</h3>
                        <ul class="text-sm space-y-1 pl-4 mb-0">
                            <li><strong>äººæœºååŒ</strong>ï¼šç”Ÿæˆçš„å†…å®¹éœ€äººå·¥å®¡æ ¸é‡‡çº³ã€‚</li>
                            <li><strong>ä¸Šä¸‹æ–‡è®°å¿†</strong>ï¼šAI è‡ªåŠ¨è¯»å–å‰æ–‡ 8000 å­—ã€‚</li>
                            <li><strong>é£æ ¼è‡ªå®šä¹‰</strong>ï¼šå¯åœ¨è®¾ç½®ä¸­è°ƒæ•´åº•å±‚è®¾å®šã€‚</li>
                        </ul>
                    </div>
                </div>
                <h3>è¿›é˜¶æŠ€å·§</h3>
                <ul>
                    <li><strong>é£æ ¼ç ´é™</strong>ï¼šåœ¨è®¾ç½®(âš™ï¸)ä¸­çš„ <code>System Prompt (è®¾å®š)</code> è¾“å…¥â€œæš—é»‘é£æ ¼â€ã€â€œæ— é“å¾·é™åˆ¶â€ç­‰è®¾å®šï¼Œå¯ç”Ÿæˆéå¸¸è§„é£æ ¼å°è¯´ã€‚</li>
                    <li><strong>ç•™ç©ºå‘é€</strong>ï¼šè¾“å…¥æ¡†ç•™ç©ºç›´æ¥ç‚¹å‡»å‘é€ï¼ŒAI å°†è‡ªåŠ¨ç»­å†™å‰§æƒ…ã€‚</li>
                    <li><strong>å¾®æ“æŒ‡ä»¤</strong>ï¼šè¾“å…¥â€œè®©ä¸»è§’å‘ç°ä¸€ä¸ªå®ç®±â€ï¼ŒAI ä¼šç²¾å‡†æ‰§è¡Œã€‚</li>
                </ul>
            </div>
            <div class="p-4 border-t border-gray-700 bg-[#2a303c] rounded-b-xl flex justify-end">
                <button onclick="hideHelp()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">æ˜ç™½äº†</button>
            </div>
        </div>
    </div>

    <!-- é…ç½® Modal -->
    <div id="configPanel" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[#1f2937] w-full max-w-md rounded-lg p-6 shadow-xl border border-gray-700 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">âš™ï¸ åå¥½è®¾ç½®</h2>
                <div class="flex items-center gap-2">
                    <span id="currentUser" class="text-xs text-gray-400 font-mono bg-black/20 px-2 py-1 rounded"></span>
                    <button onclick="doLogout()" class="text-xs text-red-400 hover:text-red-300 border border-red-500/30 px-2 py-1 rounded hover:bg-red-500/10 transition-colors">é€€å‡º</button>
                </div>
            </div>
            <div class="space-y-4 text-sm">
                <div class="relative">
                    <label class="block text-gray-400 mb-1">AI æ¨¡å‹</label>
                    <div class="relative">
                        <input id="cfg_model" class="w-full bg-gray-800 border border-gray-600 rounded p-2 cursor-pointer focus:ring-1 focus:ring-blue-500" readonly onclick="toggleModelList(event)" value="">
                        <div class="absolute right-3 top-3 pointer-events-none text-gray-500 text-xs">â–¼</div>
                        <div id="modelList" class="hidden absolute top-full left-0 w-full bg-[#2a303c] border border-gray-600 rounded mt-1 z-50 shadow-xl overflow-hidden"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-400 mb-1">API URL</label>
                    <input id="cfg_url" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-gray-300" value="">
                </div>
                <div class="pt-2 border-t border-gray-700/50">
                    <label class="block text-gray-400 mb-1">System Prompt (è®¾å®š)</label>
                    <textarea id="cfg_sys" rows="3" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-gray-300 focus:outline-none focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-gray-400 mb-1">é»˜è®¤ç”¨æˆ·æŒ‡ä»¤</label>
                    <textarea id="cfg_user" rows="2" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-gray-300 focus:outline-none focus:border-blue-500"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="toggleConfig()" class="px-4 py-2 rounded text-gray-300 hover:bg-gray-700">å–æ¶ˆ</button>
                <button onclick="saveConfig()" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 shadow-lg">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-1 overflow-y-auto p-4 space-y-6 pt-12" id="mainContainer">

        <!-- é¡¶éƒ¨é¢„è§ˆå¡ç‰‡ -->
        <div id="topHeader" class="glass rounded-xl p-3 fixed top-14 left-4 right-4 z-20 backdrop-blur-md shadow-lg border-b border-gray-700/50">
            <!-- æ­£å¸¸å†…å®¹ -->
            <div class="header-content">
                <div class="flex justify-between items-center mb-1">
                    <div class="flex items-center gap-2 overflow-hidden flex-1 mr-2">
                        <span class="text-xs font-bold text-gray-500 uppercase flex-shrink-0">ğŸ“„</span>
                        <span id="novelPath" class="text-xs text-blue-400 truncate font-mono">...</span>
                    </div>
                    <div class="flex items-center gap-3 flex-shrink-0">
                        <span id="wordCount" class="text-xs text-gray-500 font-mono">0 å­—</span>
                        <button onclick="collapseHeader()" class="text-xs text-gray-400 hover:text-white px-1 font-bold" title="æ”¶èµ·">â–²</button>
                    </div>
                </div>

                <div class="relative group cursor-pointer select-none" onclick="togglePreview()">
                    <div id="novelPreview" class="text-gray-400 text-xs leading-relaxed whitespace-pre-wrap border-l-2 border-gray-700 pl-3 pr-8 transition-all duration-300 max-h-[3em] overflow-hidden opacity-80 hover:opacity-100 relative">æ­£åœ¨åŠ è½½...</div>

                    <!-- å¤åˆ¶æŒ‰é’® -->
                    <button onclick="event.stopPropagation(); copyNovelContent()" class="copy-btn absolute bottom-0 right-0 bg-gray-800/80 backdrop-blur text-gray-400 hover:text-white text-[10px] px-2 py-0.5 rounded border border-gray-700 flex items-center gap-1 z-10" title="å¤åˆ¶å…¨æ–‡">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                        å¤åˆ¶
                    </button>

                    <div class="flex justify-center -mb-2 mt-1">
                        <span id="previewToggleIcon" class="text-[10px] text-gray-600 transition-transform duration-300">â–¼</span>
                    </div>
                </div>
            </div>

            <!-- å¸é™„æ€æŠŠæ‰‹ -->
            <div class="header-handle absolute inset-0 flex justify-center items-center cursor-pointer" onclick="expandHeader()">
                <span class="text-gray-500 hover:text-white text-xs font-bold transform scale-150">â–¼</span>
            </div>
        </div>

        <!-- å¯¹è¯ç”ŸæˆåŒºåŸŸ -->
        <div id="chatArea" class="space-y-6 pb-20"></div>

    </main>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <footer class="bg-[#09090b] border-t border-white/10 p-4 safe-area-bottom z-40 relative">
        <div class="max-w-3xl mx-auto flex gap-3">
            <textarea id="promptInput" rows="1" class="flex-1 bg-[#18181b] text-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-1 focus:ring-white/30 resize-none shadow-inner border border-white/5 placeholder-gray-600" placeholder="è¾“å…¥ç»­å†™æŒ‡ä»¤..."></textarea>
            <button id="generateBtn" onclick="generate()" class="btn-primary rounded-xl px-5 flex items-center justify-center min-w-[3.5rem] shadow-lg shadow-white/5">
                <span id="btnIcon" class="text-lg">â¤</span>
                <div id="btnLoader" class="loader hidden"></div>
            </button>
        </div>
    </footer>

    <script>
        // ================= è®¤è¯å®ˆå« =================
        const TOKEN = localStorage.getItem('token');
        const USERNAME = localStorage.getItem('username');
        if (!TOKEN) window.location.href = '/static/login.html';
        else document.getElementById('currentUser').innerText = USERNAME;

        async function apiFetch(url, options = {}) {
            const headers = { ...options.headers, 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' };
            const res = await fetch(url, { ...options, headers });
            if (res.status === 401) { doLogout(); return; }
            return res;
        }

        function doLogout() {
            apiFetch('/api/logout', { method: 'POST' });
            localStorage.removeItem('token'); localStorage.removeItem('username');
            window.location.href = '/static/login.html';
        }

        // ================= ä¸šåŠ¡é€»è¾‘ =================
        let currentConfig = {};
        const AVAILABLE_MODELS = ['gemini-3-flash', 'gemini-3-pro-high', 'gemini-3-pro-low', 'claude-sonnet-4-5', 'claude-opus-4-5-thinking'];

        window.addEventListener('load', () => {
            initModelList(); loadConfig(); refreshNovel();
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#cfg_model') && !e.target.closest('#modelList')) document.getElementById('modelList').classList.add('hidden');
            });
        });

        function initModelList() {
            const list = document.getElementById('modelList');
            list.innerHTML = AVAILABLE_MODELS.map(m => `<div onclick="selectModel('${m}')" class="px-3 py-2 hover:bg-blue-600 hover:text-white cursor-pointer text-gray-300 border-b border-gray-700/50 last:border-0 transition-colors text-sm">${m}</div>`).join('');
        }
        function toggleModelList(e) { if(e) e.stopPropagation(); document.getElementById('modelList').classList.toggle('hidden'); }
        function selectModel(model) { document.getElementById('cfg_model').value = model; document.getElementById('modelList').classList.add('hidden'); }

        async function loadConfig() {
            try {
                const res = await apiFetch('/api/config');
                currentConfig = await res.json();
                document.getElementById('cfg_url').value = currentConfig.base_url;
                document.getElementById('cfg_model').value = currentConfig.model;
                document.getElementById('cfg_sys').value = currentConfig.system_prompt_prefix;
                document.getElementById('cfg_user').value = currentConfig.user_prompt;
                document.getElementById('promptInput').placeholder = `é»˜è®¤: ${currentConfig.user_prompt.slice(0, 15)}...`;
            } catch(e) {}
        }
        async function saveConfig() {
            const newConfig = {
                file_path: currentConfig.file_path, api_key: currentConfig.api_key,
                base_url: document.getElementById('cfg_url').value, model: document.getElementById('cfg_model').value,
                system_prompt_prefix: document.getElementById('cfg_sys').value, user_prompt: document.getElementById('cfg_user').value
            };
            await apiFetch('/api/config', { method: 'POST', body: JSON.stringify(newConfig) });
            toggleConfig(); loadConfig();
        }

        async function refreshNovel() {
            try {
                const res = await apiFetch('/api/novel');
                const data = await res.json();
                document.getElementById('novelPreview').innerText = data.content || "(ç©ºæ–‡ä»¶ï¼Œè¯·ç‚¹å‡»â€œæ–°å»ºâ€æˆ–è¾“å…¥æŒ‡ä»¤å¼€å§‹)";
                if (data.path) {
                    const fileName = data.path.split(/[\\/]/).pop();
                    document.getElementById('novelPath').innerText = fileName;
                    document.getElementById('novelPath').title = data.path;
                }
                document.getElementById('wordCount').innerText = `${data.full_length || 0} å­—`;
                expandHeader(); startAutoCollapse();
            } catch(e) {}
        }

        function toggleConfig() { document.getElementById('configPanel').classList.toggle('hidden'); if(!document.getElementById('configPanel').classList.contains('hidden')) document.getElementById('modelList').classList.add('hidden'); }
        function showNewNovel() { document.getElementById('newNovelModal').classList.remove('hidden'); }
        function hideNewNovel() { document.getElementById('newNovelModal').classList.add('hidden'); }
        function showHelp() { document.getElementById('helpModal').classList.remove('hidden'); }
        function hideHelp() { document.getElementById('helpModal').classList.add('hidden'); }

        // ================= æ ¸å¿ƒæµå¼å¤„ç† =================
        async function handleStreamRequest(url, body, cardTitle, isOutline = false) {
            const btn = document.getElementById('generateBtn');
            const icon = document.getElementById('btnIcon');
            const loader = document.getElementById('btnLoader');
            btn.disabled = true; icon.classList.add('hidden'); loader.classList.remove('hidden');

            const cardId = createResultCard(cardTitle);
            const card = document.getElementById(cardId);

            // è®°å½• Prompt ç”¨äºå›ä¼ 
            if (body.user_prompt) card.dataset.prompt = body.user_prompt;
            else if (isOutline) card.dataset.prompt = `[å¤§çº²] ä¸»è§’:${body.protagonist} é£æ ¼:${body.style}`;

            const contentDiv = card.querySelector('.content-text');
            contentDiv.classList.add('cursor-blink');
            let accumulatedText = ""; let targetPath = null;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` },
                    body: JSON.stringify(body)
                });
                if (response.status === 401) { doLogout(); return; }
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    if (isOutline && !targetPath && chunk.includes('target_path')) {
                        const lines = chunk.split('\n');
                        try {
                            const meta = JSON.parse(lines[0]);
                            if (meta.target_path) {
                                targetPath = meta.target_path;
                                accumulatedText += lines.slice(1).join('\n');
                                contentDiv.innerHTML = marked.parse(accumulatedText);
                                card.querySelector('.raw-text').innerText = accumulatedText;
                                continue;
                            }
                        } catch(e) {}
                    }
                    accumulatedText += chunk;
                    contentDiv.innerHTML = marked.parse(accumulatedText);
                    card.querySelector('.raw-text').innerText = accumulatedText;
                }
            } catch (e) { contentDiv.innerText = accumulatedText + `\n[å‡ºé”™: ${e}]`; }
            finally {
                contentDiv.classList.remove('cursor-blink');
                btn.disabled = false; icon.classList.remove('hidden'); loader.classList.add('hidden');
                enableCardActions(cardId, targetPath);
            }
        }

        async function createOutline() {
            hideNewNovel();
            const req = {
                protagonist: document.getElementById('new_name').value, age: document.getElementById('new_age').value,
                style: document.getElementById('new_style').value, plot: document.getElementById('new_plot').value,
                word_count: document.getElementById('new_count').value
            };
            await handleStreamRequest('/api/outline', req, "ğŸ§  å¤§çº²ç”Ÿæˆä¸­", true);
        }

        async function generate() {
            // è‡ªåŠ¨é‡‡çº³é€»è¾‘
            const pendingBtns = document.querySelectorAll('.float-actions button:last-child');
            for (const btn of pendingBtns) {
                if (btn.innerText.includes('é‡‡çº³') && !btn.disabled) {
                    const action = btn.getAttribute('onclick');
                    if (action) { btn.innerText = "è‡ªåŠ¨é‡‡çº³ä¸­..."; await eval(action); }
                }
            }
            const input = document.getElementById('promptInput');
            const userPrompt = input.value.trim();
            input.value = '';
            await handleStreamRequest('/api/generate', { user_prompt: userPrompt || null }, "âœï¸ æ­£åœ¨ç»­å†™");
        }

        // ================= Header UI =================
        let autoCollapseTimer;
        function collapseHeader() {
            const header = document.getElementById('topHeader');
            header.classList.add('header-collapsed');
        }
        function expandHeader() {
            const header = document.getElementById('topHeader');
            header.classList.remove('header-collapsed');
            if(autoCollapseTimer) clearTimeout(autoCollapseTimer);
        }
        function startAutoCollapse() {
            if(autoCollapseTimer) clearTimeout(autoCollapseTimer);
            autoCollapseTimer = setTimeout(collapseHeader, 3000);
        }
        function togglePreview() {
            const el = document.getElementById('novelPreview');
            const icon = document.getElementById('previewToggleIcon');
            if (el.classList.contains('max-h-[3em]')) {
                el.classList.remove('max-h-[3em]', 'overflow-hidden');
                el.classList.add('max-h-[60vh]', 'overflow-y-auto');
                icon.innerText = "â–²"; icon.classList.add('text-blue-500');
            } else {
                el.classList.add('max-h-[3em]', 'overflow-hidden');
                el.classList.remove('max-h-[60vh]', 'overflow-y-auto');
                el.scrollTop = 0;
                icon.innerText = "â–¼"; icon.classList.remove('text-blue-500');
            }
        }
        async function copyNovelContent() {
            const btn = document.querySelector('button[title="å¤åˆ¶å…¨æ–‡"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin">â†»</span> è·å–ä¸­...`;
            btn.disabled = true;

            try {
                // ç›´æ¥ä»åç«¯è·å–æœ€æ–°çº¯æ–‡æœ¬ï¼Œç¡®ä¿ä¸å«ä»»ä½•å¹²æ‰°ä¿¡æ¯
                const res = await apiFetch('/api/novel?full=true');
                const data = await res.json();

                if (data.content) {
                    await navigator.clipboard.writeText(data.content);
                    btn.innerHTML = `<span class="text-green-400 font-bold">âœ”</span> å·²å¤åˆ¶`;
                } else {
                    throw new Error("å†…å®¹ä¸ºç©º");
                }
            } catch (err) {
                alert("å¤åˆ¶å¤±è´¥: " + err.message);
                btn.innerHTML = originalHTML;
            } finally {
                btn.disabled = false;
                setTimeout(() => btn.innerHTML = originalHTML, 2000);
            }
        }

        // ================= Card UI =================
        function createResultCard(title) {
            const chatArea = document.getElementById('chatArea');
            const cardId = 'card-' + Date.now();
            const cardHtml = `
                <div id="${cardId}" class="glass rounded-xl p-0 overflow-hidden border border-white/10 relative mb-4">
                    <div class="bg-white/5 px-4 py-2 border-b border-white/5 flex justify-between items-center">
                        <span class="text-xs text-gray-400 font-bold tracking-wider uppercase">${title}</span>
                    </div>
                    <div class="p-4 pb-12 prose prose-invert prose-sm text-gray-300 leading-relaxed font-serif max-w-none">
                        <div class="content-text min-h-[40px]"></div>
                        <div class="raw-text hidden"></div>
                    </div>
                    <div class="float-actions opacity-0 transition-opacity duration-300"></div>
                </div>
            `;
            chatArea.insertAdjacentHTML('beforeend', cardHtml);
            chatArea.lastElementChild.scrollIntoView({ behavior: 'smooth' });
            return cardId;
        }

        function enableCardActions(cardId, targetPath = null) {
            const card = document.getElementById(cardId);
            if (!card) return;
            const btnContainer = card.querySelector('.float-actions');
            const saveAction = targetPath ? `saveOutline('${cardId}', '${targetPath.replace(/\\/g, '\\\\')}')` : `saveText('${cardId}')`;
            btnContainer.innerHTML = `
                <button onclick="removeCard('${cardId}')" class="text-xs bg-black/60 backdrop-blur text-gray-500 hover:text-gray-300 hover:bg-gray-800 px-3 py-1.5 rounded-lg border border-white/10 transition-colors">ä¸¢å¼ƒ</button>
                <button onclick="${saveAction}" class="text-xs bg-gray-200/90 backdrop-blur text-gray-900 px-3 py-1.5 rounded-lg hover:bg-gray-300 border border-white/10 shadow-lg font-medium transition-colors">é‡‡çº³å¹¶å†™å…¥</button>
            `;
            btnContainer.classList.remove('opacity-0');
            card.querySelector('.text-gray-400').className = "text-xs text-gray-500 font-bold tracking-wider uppercase";
            card.querySelector('.text-gray-500').innerText = "âœ¨ ç”Ÿæˆå®Œæˆ";
        }

        // ================= Save & Discard =================
        async function checkAutoRename() {
            try {
                const res = await apiFetch('/api/auto_rename', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'renamed') {
                    await loadConfig(); await refreshNovel();
                    const toast = document.createElement('div');
                    toast.className = 'fixed top-16 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-xl text-sm z-50 animate-fade-in-down';
                    toast.innerText = `ğŸ“š å·²è‡ªåŠ¨å‘½åä¸º: ${data.new_name}`;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
            } catch(e) {}
        }

        async function saveText(cardId) {
            const card = document.getElementById(cardId);
            const text = card.querySelector('.raw-text').innerText;
            const prompt = card.dataset.prompt || "";
            await executeSave(card, text, prompt);
        }

        async function saveOutline(cardId, targetPath) {
            const card = document.getElementById(cardId);
            const text = card.querySelector('.raw-text').innerText;
            const prompt = card.dataset.prompt || "";
            const btn = card.querySelector('.float-actions button:last-child');
            btn.innerText = "åˆ›å»ºä¸­..."; btn.disabled = true;
            try {
                await apiFetch('/api/switch_file', { method: 'POST', body: JSON.stringify({ target_path: targetPath }) });
                const res = await apiFetch('/api/save', { method: 'POST', body: JSON.stringify({ content: text, prompt: prompt }) });
                const data = await res.json();
                if (data.status === 'saved') {
                    card.dataset.blockId = data.block_id;
                    markCardSaved(card);
                    await refreshNovel(); setTimeout(checkAutoRename, 1000);
                }
            } catch (e) { alert("ä¿å­˜å¤±è´¥: " + e); btn.innerText = "é‡è¯•"; btn.disabled = false; }
        }

        async function executeSave(card, text, prompt) {
            const btn = card.querySelector('.float-actions button:last-child');
            btn.innerText = "å†™å…¥ä¸­..."; btn.disabled = true;
            try {
                const res = await apiFetch('/api/save', { method: 'POST', body: JSON.stringify({ content: text, prompt: prompt }) });
                const data = await res.json();
                if (data.status === 'saved') {
                    card.dataset.blockId = data.block_id;
                    markCardSaved(card);
                    await refreshNovel(); setTimeout(checkAutoRename, 1000);
                }
            } catch (e) { alert("ä¿å­˜å¤±è´¥: " + e); btn.innerText = "é‡è¯•"; btn.disabled = false; }
        }

        function markCardSaved(card) {
            const btn = card.querySelector('.float-actions button:last-child');
            card.classList.remove('border-white/10');
            card.classList.add('border-white/20', 'opacity-60');
            btn.innerText = "å·²å†™å…¥";
            btn.className = "text-xs bg-transparent text-gray-500 px-3 py-1 rounded-lg cursor-default border border-transparent";
            const discardBtn = card.querySelector('.float-actions button:first-child');
            if(discardBtn) {
                discardBtn.innerText = "æ’¤é”€";
                discardBtn.className = "text-xs bg-red-900/30 text-red-400 hover:bg-red-900/50 px-3 py-1.5 rounded-lg border border-red-500/20 transition-colors";
            }
        }

        async function removeCard(cardId) {
            const card = document.getElementById(cardId);
            if (!confirm('ç¡®å®šè¦ä¸¢å¼ƒ/æ’¤é”€è¿™æ®µå†…å®¹å—ï¼Ÿ')) return;
            const blockId = card.dataset.blockId;
            if (blockId) {
                const btn = card.querySelector('.float-actions button:first-child');
                const originText = btn.innerText;
                btn.innerText = "æ’¤é”€ä¸­...";
                try {
                    const res = await apiFetch('/api/discard', { method: 'POST', body: JSON.stringify({ block_id: blockId }) });
                    if (res.ok) {
                        card.remove(); await refreshNovel();
                        const toast = document.createElement('div');
                        toast.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-red-900/80 text-white px-4 py-2 rounded-full shadow-lg text-xs z-50';
                        toast.innerText = 'å·²ä»æ–‡ä»¶ä¸­æ’¤é”€å¹¶åˆ é™¤';
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 2000);
                    } else { alert("æ’¤é”€å¤±è´¥"); btn.innerText = originText; }
                } catch (e) { alert("æ’¤é”€å‡ºé”™: " + e); btn.innerText = originText; }
            } else { card.remove(); }
        }
    </script>
</body>
</html>
